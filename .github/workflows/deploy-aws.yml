name: Deploy to AWS EC2

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    types:
      - completed
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # Ensure Docker is installed
            if ! command -v docker &> /dev/null; then
              echo "üîß Docker not found. Installing Docker..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker $USER
              echo "‚úÖ Docker installed successfully"
            fi
            
            # Ensure docker-compose is installed
            if ! command -v docker-compose &> /dev/null; then
              echo "üîß Docker Compose not found. Installing Docker Compose..."
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
              echo "‚úÖ Docker Compose installed successfully"
            fi
            
            # Navigate to app directory
            cd ~/abhayvideography || mkdir -p ~/abhayvideography && cd ~/abhayvideography
            
            # Check if SSL is configured
            if [ -d "/etc/letsencrypt/live" ] && [ -f "nginx-ssl.conf" ]; then
              echo "üîí SSL certificates detected - using SSL configuration"
              SSL_ENABLED=true
            else
              echo "‚ö†Ô∏è  No SSL certificates found - using HTTP only"
              SSL_ENABLED=false
            fi
            
            # Create appropriate docker-compose.yml based on SSL status
            if [ "$SSL_ENABLED" = true ]; then
              echo "üìù Creating docker-compose.yml with SSL support..."
              cat > docker-compose.yml << 'EOF'
            services:
              backend:
                image: abhaypratapsingh7704866570/abhayvideography-backend:latest
                container_name: abhayvideography-backend
                environment:
                  - NODE_ENV=production
                networks:
                  - app-network
                restart: unless-stopped
                expose:
                  - "3000"
                healthcheck:
                  test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s
            
              frontend:
                image: abhaypratapsingh7704866570/abhayvideography-frontend:latest
                container_name: abhayvideography-frontend
                networks:
                  - app-network
                restart: unless-stopped
                expose:
                  - "80"
                healthcheck:
                  test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s
            
              nginx:
                image: nginx:alpine
                container_name: abhayvideography-nginx
                ports:
                  - "80:80"
                  - "443:443"
                volumes:
                  - ./nginx-ssl.conf:/etc/nginx/nginx.conf:ro
                  - /etc/letsencrypt:/etc/letsencrypt:ro
                depends_on:
                  - backend
                  - frontend
                networks:
                  - app-network
                restart: unless-stopped
                healthcheck:
                  test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s
            
            networks:
              app-network:
                driver: bridge
            EOF
            else
              echo "üìù Creating docker-compose.yml (HTTP only)..."
              cat > docker-compose.yml << 'EOF'
            services:
              backend:
                image: abhaypratapsingh7704866570/abhayvideography-backend:latest
                container_name: abhayvideography-backend
                environment:
                  - NODE_ENV=production
                networks:
                  - app-network
                restart: unless-stopped
                expose:
                  - "3000"
                healthcheck:
                  test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s
            
              frontend:
                image: abhaypratapsingh7704866570/abhayvideography-frontend:latest
                container_name: abhayvideography-frontend
                networks:
                  - app-network
                restart: unless-stopped
                expose:
                  - "80"
                healthcheck:
                  test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s
            
              nginx:
                image: nginx:alpine
                container_name: abhayvideography-nginx
                ports:
                  - "80:80"
                volumes:
                  - ./nginx.conf:/etc/nginx/nginx.conf:ro
                depends_on:
                  - backend
                  - frontend
                networks:
                  - app-network
                restart: unless-stopped
                healthcheck:
                  test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s
            
            networks:
              app-network:
                driver: bridge
            EOF
            fi
            
            # Create nginx.conf if it doesn't exist
            if [ ! -f nginx.conf ]; then
              echo "üìù Creating nginx.conf..."
              cat > nginx.conf << 'EOF'
            user nginx;
            worker_processes auto;
            error_log /var/log/nginx/error.log warn;
            pid /var/run/nginx.pid;
            
            events {
                worker_connections 1024;
            }
            
            http {
                include /etc/nginx/mime.types;
                default_type application/octet-stream;
            
                log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                                '$status $body_bytes_sent "$http_referer" '
                                '"$http_user_agent" "$http_x_forwarded_for"';
            
                access_log /var/log/nginx/access.log main;
            
                sendfile on;
                tcp_nopush on;
                tcp_nodelay on;
                keepalive_timeout 65;
                types_hash_max_size 2048;
                client_max_body_size 20M;
            
                gzip on;
                gzip_vary on;
                gzip_min_length 1024;
                gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;
            
                upstream backend {
                    server backend:3000;
                }
            
                upstream frontend {
                    server frontend:80;
                }
            
                server {
                    listen 80;
                    server_name _;
            
                    location /api {
                        proxy_pass http://backend;
                        proxy_http_version 1.1;
                        proxy_set_header Upgrade $http_upgrade;
                        proxy_set_header Connection 'upgrade';
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Forwarded-Proto $scheme;
                        proxy_cache_bypass $http_upgrade;
                    }
            
                    location / {
                        proxy_pass http://frontend;
                        proxy_http_version 1.1;
                        proxy_set_header Upgrade $http_upgrade;
                        proxy_set_header Connection 'upgrade';
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Forwarded-Proto $scheme;
                        proxy_cache_bypass $http_upgrade;
                    }
                }
            }
            EOF
            fi
            
            # Pull latest images
            echo "üê≥ Pulling latest Docker images..."
            if ! docker pull abhaypratapsingh7704866570/abhayvideography-backend:latest; then
              echo "‚ùå Failed to pull backend image. Please ensure it exists in Docker Hub."
              exit 1
            fi
            
            if ! docker pull abhaypratapsingh7704866570/abhayvideography-frontend:latest; then
              echo "‚ùå Failed to pull frontend image. Please ensure it exists in Docker Hub."
              exit 1
            fi
            
            echo "‚úÖ Images pulled successfully"
            
            # Stop existing containers
            echo "üõë Stopping existing containers..."
            docker-compose down || true
            
            # Remove old images
            echo "üßπ Cleaning up old images..."
            docker image prune -f
            
            # Start new containers
            echo "üöÄ Starting new containers..."
            docker-compose up -d
            
            # Wait a moment for containers to start
            sleep 5
            
            # Check for failed containers and show logs
            echo "üîç Checking container status..."
            FAILED=0
            for container in abhayvideography-backend abhayvideography-frontend abhayvideography-nginx; do
              if [ "$(docker inspect -f '{{.State.Status}}' $container 2>/dev/null)" != "running" ]; then
                echo "‚ùå Container $container is not running!"
                echo "üìã Logs for $container:"
                docker logs $container 2>&1 | tail -50
                FAILED=1
              else
                echo "‚úÖ Container $container is running"
              fi
            done
            
            # Check status
            echo ""
            echo "üìä Container status:"
            docker-compose ps
            
            if [ $FAILED -eq 1 ]; then
              echo "‚ùå Some containers failed to start. Check logs above."
              exit 1
            fi
            
            echo "‚úÖ Deployment completed successfully!"

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # Wait for services to be ready
            sleep 10
            
            # Check if Docker is available
            if ! command -v docker &> /dev/null; then
              echo "‚ùå Docker is not available. Please run the deployment step first."
              exit 1
            fi
            
            # Navigate to app directory
            cd ~/abhayvideography
            
            # Check if containers are running
            CONTAINER_COUNT=$(docker ps -q | wc -l)
            if [ $CONTAINER_COUNT -gt 0 ]; then
              echo "‚úÖ $CONTAINER_COUNT container(s) are running"
              docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            else
              echo "‚ùå No containers are running"
              echo "Checking logs..."
              docker-compose logs --tail=50
              exit 1
            fi

      - name: Notify Success
        if: success()
        run: |
          echo "üéâ Deployment to AWS EC2 completed successfully!"
          echo "üåê Application is live at: http://${{ secrets.EC2_HOST }}"

      - name: Notify Failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed. Please check the logs above."
